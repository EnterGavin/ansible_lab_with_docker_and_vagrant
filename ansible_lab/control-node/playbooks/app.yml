---
- name: Configurar servidor de aplicacao java
  hosts: app01
  become: true

  vars:
    dbhosts: "db01"
    dbname: "notes"
    dbusername: "notesapps"
    dbpassword: "12345"

  tasks:
    # --------------------------------------------------
    # HOSTS
    # --------------------------------------------------
    - name: Configurar hosts lab_ansible
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
        create: yes
        unsafe_writes: yes
      loop:
        - "172.17.0.2 control_node"
        - "172.17.0.3 db01"
        - "172.17.0.4 app01"

    # --------------------------------------------------
    # USUARIO
    # --------------------------------------------------
    - name: Adicionar usuario da aplicacao
      user:
        name: app
        comment: Usuario da aplicacao
        uid: 500
        shell: /bin/bash
        create_home: yes

    # --------------------------------------------------
    # APLICACAO
    # --------------------------------------------------
    - name: Garantir diretorio da aplicacao
      file:
        path: /opt/notes
        state: directory
        owner: app
        group: app
        mode: "0755"

    - name: Clone do repositorio Notes - app
      git:
        repo: https://github.com/callicoder/spring-boot-mysql-rest-api-tutorial.git
        dest: /opt/notes
        update: yes
        force: yes
      become_user: app

    - name: Ajustar permissoes da aplicacao
      file:
        path: /opt/notes
        owner: app
        group: app
        recurse: yes

    - name: Configurar application.properties
      template:
        src: application.properties
        dest: /opt/notes/src/main/resources/application.properties
        owner: app
        group: app
        mode: "0644"

    # --------------------------------------------------
    # BUILD (SEM TESTES)
    # --------------------------------------------------
    - name: Gerar pacote da aplicacao (sem testes)
      command: mvn clean package -DskipTests
      args:
        chdir: /opt/notes
      become_user: app

    # --------------------------------------------------
    # EXECUCAO (SEM SYSTEMD)
    # --------------------------------------------------
    - name: Localizar jar gerado
      shell: ls /opt/notes/target/*.jar | head -n 1
      register: app_jar
      changed_when: false

    - name: Copiar jar para local padrao
      copy:
        src: "{{ app_jar.stdout }}"
        dest: /opt/notes/app.jar
        remote_src: yes
        owner: app
        group: app
        mode: "0755"

    - name: Parar aplicacao antiga (se existir)
      shell: |
        pgrep -f "/opt/notes/app.jar" && pkill -f "/opt/notes/app.jar" || true

    - name: Subir aplicacao Spring Boot
      shell: |
        nohup java -jar /opt/notes/app.jar \
          > /opt/notes/notes.log 2>&1 &
      become_user: app
